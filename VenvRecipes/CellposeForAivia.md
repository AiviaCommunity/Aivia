# Cellpose For Aivia

## Cellpose Information

This Aivia python recipe applies the Cellpose deep learning model to generate segmentation for cells/nucleus in 2D or 3D images.

Online information about Cellpose are listed below:

* Cellpose Website: http://www.cellpose.org/
* Cellpose GitHub: https://github.com/MouseLand/cellpose
* Cellpose documentation: http://www.cellpose.org/static/docs/index.html
* Cellpose paper: https://www.biorxiv.org/content/10.1101/2020.02.02.931238v1

## Requirements

* Cellpose_venv - the Cellpose python virtual environment in a folder that contains all required python packages to run the Cellpose

* Python 3.6 - comes with Aivia

## Installation

1. Download the Cellpose virtual environment ZIP file from Dropbox:
    1. (New version, Cellpose 0.0.3.1) [Cellpose_virtualEnvironment_0031.zip](https://www.dropbox.com/s/5cjusygca6ibdeo/Cellpose_virtualEnvironment_0031.zip?dl=0). The new version allows user to adjust Cell Prabability Threshold and Flow Threshold
    2. (Old version, Cellpose 0.0.2.0) [Cellpose_virtualEnvironment.zip](https://www.dropbox.com/s/0dczdliehhqj0wr/Cellpose_virtualEnvironment.zip?dl=1)

2. Unzip "Cellpose_virtualEnvironment_0031.zip" to a local folder

3. The Cellpose python recipe for Aivia is "\Cellpose_venv_0031\Cellpose_Aivia.py"

## Execution

1. Load Cellpose python recipe "Cellpose_Aivia.py" onto Aivia
   1. "Cellpose_Aivia.py" is stored under the top folder "\Cellpose_venv"
   2. Load the recipe by using "File>Open" or drag-and-drop
2. Load target image onto Aivia
3. In Aivia analysis tools, adjust input, output, and processing parameters
4. Click on "Start" button and wait for the result

## Parameters

* Input Image : Aivia channel
  * Input channel to segment.

* Diameter (px) : double
  * Approximate size of the structures you wish to segment (in pixels), must greater than zero.

* Model Type (0=cyto, 1=nuc) l : int (bool)
  * Boolean to determine which Cellpose model you wish to run.
    * 0 : Choose the cytoplasm model (segment the whole cell).
    * 1 : Choose the nuclei model

* (New Version Only) [Cell Probability Threshold](https://cellpose.readthedocs.io/en/latest/settings.html?highlight=threshold#cell-probability-threshold) : double, default is 0.0, range from -6.0 to 6.0

    The pixels greater than the Cell Probability(confidence) are used to
    run dynamics and determine masks. The threshold is calculated using a
    Sigmoid function centered at zero (1 / (1 + e^-x)). So the value is
    around -6.0 to 6.0. Decrease this threshold will return more cell masks.

* (New Version Only) [Flow Threshold](https://cellpose.readthedocs.io/en/latest/settings.html?highlight=threshold#flow-threshold) : double, suggested default is 0.4

    The Flow Threshold is the maximum allowed error of the flows for each mask.
    Increase this threshold if cellpose is not returning as many masks as
    expected.

## Returns

* Mask : Aivia channel
  * The labeled segmentation mask generated by applying the Cellpose model.
* Confidence Map : Aivia channel
  * The XY flow (for 2D) or Z flow (for 3D) generated by applying the Cellpose model. It represents the confidence that each voxel belongs to the segmentation mask.
